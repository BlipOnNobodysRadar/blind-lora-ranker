<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Lora Elo Rankings</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <!-- Standardized Navigation Bar -->
  <nav class="navigation">
    <a href="index.html">Rate Images</a>
    <a href="rankings.html">View Image Elo Rankings</a>
    <a href="lora-rankings.html">View LoRA Elo Rankings</a>
    <a href="compare-loras.html">Compare LoRAs</a>
  </nav>

  <div class="subset-select">
    <label for="subset">Choose a subset:</label>
    <select id="subset" onchange="changeSubset()"></select>
  </div>
  
  <div class="controls">
    <div>
      <label for="search">Search LoRA:</label>
      <input type="text" id="search" oninput="filterResults()" placeholder="Type to search...">
    </div>
    <div>
      <button onclick="downloadCSV()">Download CSV</button>
    </div>
  </div>

  <div class="notification" id="notification">
    All LoRA models have reached the minimum threshold for stable rankings!
  </div>
  
  <h1>Lora Model Elo Rankings</h1>
  <div class="summary" id="summary"></div>

  <div class="ranking-header" id="ranking-header">
    <span data-sort="lora">LoRA Model</span>
    <span data-sort="matches">Matches</span>
    <span data-sort="rating">Rating</span>
  </div>
  
  <div class="ranking-container" id="ranking-container"></div>

  <script>
    let loraData = [];
    let currentSubset = '';
    let currentSort = { field: 'rating', direction: 'desc' };

    document.addEventListener('DOMContentLoaded', (event) => {
      fetchSubsets();
    });

    function fetchSubsets() {
      fetch('/api/subsets')
        .then(res => res.json())
        .then(data => {
          const subsetSelect = document.getElementById('subset');
          subsetSelect.innerHTML = '';
          data.forEach(s => {
            const option = document.createElement('option');
            option.value = s;
            option.textContent = s;
            subsetSelect.appendChild(option);
          });
          const params = new URLSearchParams(window.location.search);
          currentSubset = params.get('subset') || data[0];
          subsetSelect.value = currentSubset;
          fetchRankings(currentSubset);
          fetchSummary(currentSubset);
        })
        .catch(error => console.error('Error fetching subsets:', error));
    }

    function fetchRankings(subset) {
      fetch(`/api/lora-rankings/${subset}`)
        .then(response => response.json())
        .then(data => {
          if (!Array.isArray(data)) {
            console.error('Unexpected data format:', data);
            return;
          }
          loraData = data;
          renderRankings();
        })
        .catch(error => {
          console.error('Error fetching rankings:', error);
        });
    }

    function fetchSummary(subset) {
      fetch(`/api/summary/${subset}/lora`)
        .then(res => res.json())
        .then(data => {
          const summaryDiv = document.getElementById('summary');
          summaryDiv.innerHTML = `
            <p>Total LoRA Models: ${data.count}</p>
            <p>Average Rating: ${data.averageRating.toFixed(2)}</p>
            <p>Average Matches: ${data.averageMatches.toFixed(2)}</p>
          `;
        })
        .catch(err => console.error('Error fetching summary:', err));
    }

    function changeSubset() {
      const subset = document.getElementById('subset').value;
      window.location.search = `?subset=${subset}`;
    }

    function renderRankings() {
      sortRankings();
      const rankingContainer = document.getElementById('ranking-container');
      rankingContainer.innerHTML = '';
      const searchTerm = document.getElementById('search').value.toLowerCase();

      let allMinimumReached = true;
      loraData
        .filter(item => item.lora.toLowerCase().includes(searchTerm))
        .forEach(item => {
          const progressPercentage = Math.min((item.matches / 20) * 100, 100);
          if (item.matches < 5) {
            allMinimumReached = false;
          }

          const rankingItem = document.createElement('div');
          rankingItem.className = 'ranking-item';
          rankingItem.innerHTML = `
            <span><strong>${item.lora}</strong></span>
            <span>Rating: ${item.rating.toFixed(2)}</span>
            <span>Matches: ${item.matches}</span>
            <div class="progress-bar-container">
              <div class="progress-bar-background"></div>
              <div class="progress-bar" style="width: ${progressPercentage}%;"></div>
            </div>
          `;
          rankingContainer.appendChild(rankingItem);
        });

      // Notification
      const notification = document.getElementById('notification');
      if (allMinimumReached && loraData.length > 0) {
        notification.style.display = 'block';
      } else {
        notification.style.display = 'none';
      }
    }

    function filterResults() {
      renderRankings();
    }

    function sortRankings() {
      loraData.sort((a, b) => {
        let valA = a[currentSort.field];
        let valB = b[currentSort.field];

        if (currentSort.field === 'lora') {
          valA = valA.toLowerCase();
          valB = valB.toLowerCase();
        }

        if (valA < valB) return currentSort.direction === 'asc' ? -1 : 1;
        if (valA > valB) return currentSort.direction === 'asc' ? 1 : -1;
        return 0;
      });
      updateSortIndicator();
    }

    function updateSortIndicator() {
      const header = document.getElementById('ranking-header');
      header.querySelectorAll('span').forEach(span => {
        span.classList.remove('sort-asc', 'sort-desc');
        if (span.dataset.sort === currentSort.field) {
          span.classList.add(currentSort.direction === 'asc' ? 'sort-asc' : 'sort-desc');
        }
      });
    }

    document.getElementById('ranking-header').addEventListener('click', (e) => {
      if (!e.target.dataset.sort) return;
      const field = e.target.dataset.sort;
      if (field === currentSort.field) {
        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
      } else {
        currentSort.field = field;
        currentSort.direction = 'asc';
      }
      renderRankings();
    });

    function downloadCSV() {
      window.location.href = `/api/export/${currentSubset}/lora/csv`;
    }
  </script>
</body>
</html>
